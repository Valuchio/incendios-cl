WITH BaseAgregada AS (
  SELECT
    -- 1. Columna clave para agrupar (se usa la tabla t1 para referenciar las columnas)
    t1.FECHA_REPROGRAMADA_UTC || '-' || t1.Origen_del_tramo || '-' || t1.numero_de_Vuelo AS identificador_unico,
    t1.key,
    -- 2. Columnas necesarias para la agregación
    t1.Codigo_de_atraso,
    t1.Area_responsable_de_atraso,
    t1.Codigo_de_cancelacion_del_tramo,
    t1.Vuelo_considerado_en_calculo_de_puntualidad,

    SUM(
        CASE 
          WHEN t1.Area_responsable_de_atraso = 'MTO' THEN t1.atraso_en_minutos 
          ELSE 0
        END
    ) 
    OVER (
        PARTITION BY 
            t1.FECHA_PROGRAMADA_UTC, 
            t1.Numero_de_vuelo, 
            t1.Origen_Destino_del_tramo
    ) AS Minutos_totales_MTO_Exclusivo,
    
    
  FROM 
    `dlakedomain-prod-20dl.dmt_flight_otp_us.Base` t1
)


SELECT
    identificador_unico,
    -- Concatena todos los códigos de atraso
    STRING_AGG(Codigo_de_atraso, ' // ') AS Codigos_de_atraso_Concatenados,
    -- Concatena todas las áreas responsables
    STRING_AGG(Area_responsable_de_atraso, ' // ') AS Areas_responsables_Concatenadas,
    MIN(Minutos_totales_MTO_Exclusivo) AS Atraso_MTO_Total_Por_Vuelo,
    STRING_AGG(Codigo_de_cancelacion_del_tramo, ' // ') AS Codigos_de_cancelacion,
    Vuelo_considerado_en_calculo_de_puntualidad
FROM 
    BaseAgregada
WHERE 
    --Codigo_de_atraso IS NOT NULL AND Area_responsable_de_atraso IS NOT NULL
    Codigo_de_cancelacion_del_tramo is not null
GROUP BY 
    1,Vuelo_considerado_en_calculo_de_puntualidad